<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>捐赠订单详细</title>
    <link href="../static/css/Hui.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
        #project .cy-label {
            min-width: 60px;
        }
    </style>
    <script type="text/html" id="orderTppl">

        <input type="hidden" name="out_trade_no" id="out_trade_no" value="<%=orderObj.orderNo%>">
        <input type="hidden" name="subject" id="subject" value="<%=orderObj.project.projectName%>">
        <input type="hidden" name="total_fee" id="total_fee" value="<%=orderObj.money%>">
        <input type="hidden" name="WIDbody" id="WIDbody" value="<%=orderObj.message%>">
        <input type="hidden" name="payType" value="10"><!--支付类型:10:手机支付;20:网页支付-->
        <div class="H-margin-vertical-both-10">

            <ul class="H-theme-background-color-white">
                <li class="H-padding-horizontal-both-10 H-flexbox-horizontal H-border-vertical-bottom-after H-padding-vertical-both-10">
                    <label class="cy-label H-vertical-middle H-font-size-14 H-theme-font-color-999">
                        订单流水
                    </label>
                    <label class="H-vertical-middle H-font-size-14 H-margin-horizontal-left-10"><%=orderObj.orderNo%></label>
                </li>
                <li class="H-padding-horizontal-both-10 H-flexbox-horizontal H-border-vertical-bottom-after H-padding-vertical-both-10">
                    <label class="cy-label H-vertical-middle H-font-size-14 H-theme-font-color-999">
                        捐赠项目
                    </label>
                    <label class="H-vertical-middle H-font-size-14 H-margin-horizontal-left-10"><%=orderObj.project.projectName%></label>
                </li>
                <li class="H-padding-horizontal-both-10 H-flexbox-horizontal H-border-vertical-bottom-after H-padding-vertical-both-10">
                    <label class="cy-label H-vertical-middle H-font-size-14 H-theme-font-color-999">
                        捐赠金额
                    </label>
                    <label class="H-vertical-middle H-font-size-14 H-margin-horizontal-left-10 d-money"><%=orderObj.money%>元</label>
                </li>
                <li class="H-padding-horizontal-both-10 H-flexbox-horizontal H-border-vertical-bottom-after H-padding-vertical-both-10">
                    <label class="cy-label H-vertical-middle H-font-size-14 H-theme-font-color-999">
                        捐赠时间
                    </label>
                    <label class="H-vertical-middle H-font-size-14 H-margin-horizontal-left-10"><%=orderObj.donationTime%></label>
                </li>
                <li class="H-padding-horizontal-both-10 H-flexbox-horizontal H-border-vertical-bottom-after H-padding-vertical-both-10">
                    <label class="cy-label H-vertical-middle H-font-size-14 H-theme-font-color-999">
                        捐赠留言
                    </label>
                    <label class="H-vertical-middle H-font-size-14 H-margin-horizontal-left-10"><%=orderObj.message%></label>
                </li>
                <li class="H-padding-horizontal-both-10 H-flexbox-horizontal H-border-vertical-bottom-after H-padding-vertical-both-10">
                    <label class="cy-label H-vertical-middle H-font-size-14 H-theme-font-color-999">
                        匿名捐赠
                    </label>
                    <label class="H-vertical-middle H-font-size-14 H-margin-horizontal-left-10">
                        <%if(orderObj.anonymous == '1'){%>是<%}else{%>否<%}%>
                    </label>
                </li>
                <li class="H-padding-horizontal-both-10 H-flexbox-horizontal H-border-vertical-bottom-after H-padding-vertical-both-10">
                    <label class="cy-label H-vertical-middle H-font-size-14 H-theme-font-color-999">
                        支付状态
                    </label>
                    <label class="H-vertical-middle H-font-size-14 H-margin-horizontal-left-10">
                        <%if(orderObj.payStatus == '1'){%>已支付<%}else{%>未支付<%}%>
                    </label>
                </li>
            </ul>
            <ul class="H-theme-background-color-white H-margin-vertical-top-10">
                <li class="H-flexbox-horizontal H-theme-background-color-white H-border-vertical-bottom-after H-padding-10 H-display-inline-block">
                    <strong class="H-font-size-14 H-font-weight-normal H-theme-font-color-999 H-padding-horizontal-right-5">支付方式</strong>
                </li>
                <li class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active">
							<span class="H-icon H-center-all H-display-block H-margin-horizontal-left-10 H-theme-font-color-white H-theme-background-color-transparent" style="height: 30px; width: 30px;">
								<img src="../static/img/icons/weichat.png" class="H-vertical-middle" alt="" title="" style="height: 30px; width: 30px;">
							</span>
                    <div class="H-flex-item H-padding-horizontal-both-10 H-font-size-14 H-padding-vertical-both-12">微信支付</div>
							<span class="H-icon H-padding-horizontal-right-5 H-display-block">
								<input id="weixin" type="radio" checked="checked" name="n2" value="1" class="H-radio H-radio-fill H-vertical-align-middle H-font-size-18 H-theme-font-color1 H-theme-background-color-white H-border-radius-circle H-margin-horizontal-right-10">
							</span>
                </li>
                <li class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle H-touch-active">
							<span class="H-icon H-center-all H-display-block H-margin-horizontal-left-10 H-theme-font-color-white H-theme-background-color-transparent" style="height: 30px; width: 30px;">
								<img src="../static/img/icons/icon_alipay@2x.png" class="H-vertical-middle" alt="" title="" style="height: 30px; width: 30px;">
							</span>
                    <div class="H-flex-item H-padding-horizontal-both-10 H-font-size-14 H-padding-vertical-both-12">支付宝支付</div>
							<span class="H-icon H-padding-horizontal-right-5 H-display-block">
								<input id="alipay" type="radio" name="n2" value="2" class="H-radio H-radio-fill H-vertical-align-middle H-font-size-18 H-theme-font-color1 H-theme-background-color-white H-border-radius-circle H-margin-horizontal-right-10">
							</span>
                </li>
            </ul>
        </div>
        <%if(orderObj.payStatus == '0'){%>
        <div style="height: 50px;"></div>
        <ul class="H-flexbox-horizontal H-theme-background-color-white H-border-vertical-top-after" style="position: fixed; z-index: 9999; bottom: 0;">

            <li class="H-flex-item H-padding-5">
                <input type="button" class="H-button H-font-size-15 H-width-100-percent H-outline-none H-padding-vertical-both-8 H-theme-background-color1 H-theme-font-color-white H-theme-border-color1 H-theme-border-color1-click H-theme-background-color1-click H-theme-font-color1-click H-border-radius-3" value="支&nbsp;&nbsp;付">
                <!--<button id="submitBtn" class="H-button H-font-size-15 H-width-100-percent H-outline-none H-padding-vertical-both-8 H-theme-background-color1 H-theme-font-color-white H-theme-border-color1 H-theme-border-color1-click H-theme-background-color1-click H-theme-font-color1-click H-border-radius-3">支&nbsp;&nbsp;付</button>-->
            </li>

        </ul>
        <%}%>
    </script>

</head>
<body>
<!-- list-->
<form id="form1" name="form1" method="post">
    <div  id="orderList">

    </div>
</form>
</body>

<script src="../../js/H.js" type="text/javascript"></script>
<script src="../../js/zepto.min.js" type="text/javascript" ></script>
<script src="../../js/xdomain.min.js" type="text/javascript"></script>
<script src="../../js/B.js" type="text/javascript" ></script>
<script type="text/javascript" src="../../js/jbase64.js" ></script>
<script type="text/javascript" src="../../js/wechat.js" ></script>
<script type="text/javascript">
    // 接收URL中的参数
    var donationId = B.getUrlParamByName("donationId");

    var projectId = B.getUrlParamByName("projectId");

    var accountNum = B.getUrlParamByName("accountNum");

    var openId = localStorage.getItem("openId");
    if(openId && openId != "null") {
        // 微信端
        accountNum = localStorage.getItem("accountNum");

        if(!accountNum || accountNum == ''){
            H.confirm(function (ret) {
                if(ret.buttonIndex==1){
                    var backUrl = B.encrypt("../services/donate/order.html?ts=" + B.getRandomInt(4)) + "&donationId=" + donationId;
                    H.openWin("登陆页面", "../../wechat/login.html?ts=" + B.getRandomInt(4) + "&backUrl=" + backUrl);
                }
                else{
                    history.back();
                }
            }, '确认提示：', '尚未登陆，是否登陆账号？');
        }
        $("title").html("捐赠订单详细");
        var shareData = {
            title: '捐赠订单详细',
            desc: '',
            link: location.href.split('?')[0],
            imgUrl: ''
        };
        mkShareInfo(location.href, shareData, 1);
    }
    else{
        $("title").html('{"title":"捐赠订单详细","backUrl":"/mobile/services/donate/list_my.html?accountNum=' + accountNum + '","backTitle":"返回"}');
    }

    $(function(){
        H.tppl_flag = ["<%", "%>"];

        B.ready(function(){
            $("#form1").attr("action",B.serverUrl+"/alipay/alipayAction!doNotNeedSessionAndSecurity_alipayApi.action") ;

            $.ajax({
                type: 'post',
                url: B.serverUrl+'/userProfile/userProfileAction!doNotNeedSessionAndSecurity_userProfileHandler.action',
                data:{
                    jsonStr:'{"command": "229","content": {"id": "'+donationId+'"}}'
                },
                dataType: 'json',
                success: function(data){
                    if(data.obj){
                        // 获取订单信息成功
                        var render = H.tppl(H.D("#orderTppl").innerHTML);
                        var result = render({orderObj:data.obj});

                        $('#orderList').html(result);

                        $('.H-button').on('click', function () {

                            var a = document.getElementsByName("n2");

                            for (var i=0; i<a.length; i++){
                                if(a[i].checked) {
                                    if(a[i].value==1){

                                        var money = parseFloat($('.d-money').html());
                                        var u = navigator.userAgent, app = navigator.appVersion;
                                        var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //g
                                        var isIOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
                                        if (isAndroid) {
                                            var jsonStr = {"money": money.toString(), "donationID": donationId};
                                            var str = JSON.stringify(jsonStr);
                                            window.stub.weixinPay(str)
                                        }
                                        if (isIOS) {
                                            var jsonStr = {"money": money, "donationID": donationId};
                                            /* alert(money)
                                             alert(donationId)*/
                                            window.webkit.messageHandlers.JSCallOCWeChatPay.postMessage({body: jsonStr});
                                        }
                                    }
                                    if(a[i].value==2){
                                        $.ajax({
                                            type: 'post',
                                            url: B.serverUrl + '/userProfile/userProfileAction!doNotNeedSessionAndSecurity_userProfileHandler.action',
                                            data: {
                                                jsonStr: '{"command": "231","content": {"donationId": "' + donationId + '","userId":"' + accountNum + '"}}'
                                            },
                                            dataType: 'json',
                                            success: function (data) {

                                                if (data.success) {
                                                    H.openWin("支付成功", "alipay_success.html?accountNum=" + accountNum + "&ts=" + B.getRandomInt(4) + "&donationId=" + donationId);
                                                }
                                            },
                                            error: function (xhr, type) {
                                                H.alert("支付失败！");
                                            }
                                        });
                                    }
                                }
                            }

                        });
                    }
                },
                error: function(xhr, type){
                    H.alert("获取订单信息失败！");
                }
            });
        });

    });
    function WeChatPaySuccess(){
        H.openWin("支付成功", "alipay_success.html?accountNum=" + accountNum + "&ts=" + B.getRandomInt(4) + "&donationId=" + donationId);
    }
//    //ios返回刷新
//    var t = B.getUrlParamByName("t");
//    $(function () {
//        var u = navigator.userAgent, app = navigator.appVersion;
//        var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Linux') > -1; //g
//        var isIOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
//        if (isAndroid) {
//
//        }
//        if (isIOS) {
//            var rnumber = Math.floor(Math.random()*1000)
//            history.replaceState({mod:rnumber}, 'Title', '?t='+t+'&accountNum='+accountNum+'&mod='+rnumber+ "&projectId="+ projectId +"&donationId=" + donationId);
//            window.onpopstate = function(event) {
//                location.reload();
//            };
//        }
//    });

    //返回
    var jsonStrBut = {
        "title":"捐赠订单",
        "btn1":{
            "imgname":"icon_Back@2x.png",
            "imgversion":"20170214",
            "imgbase64":"iVBORw0KGgoAAAANSUhEUgAAABoAAAAsCAYAAAB7aah+AAAAAXNSR0IArs4c6QAAAN1JREFUWAntlkEOgkAMRRkTVl7EA3gPD+D53MjGa7lyr4vxF2gghkIHqnHxmzQdMp3+6YOkVFWw5ZxP8Cu8Di49lOtFnohiN3i8GIpKJyqCZWuxYig5JdJrdZ3thsbXrUQEJxt4PCa90kIn0tF2dBRR3K5IXC5MmkRcSsIVicuFSZOIS0l4owy+M3xuaF1SSi9vQTMP76aGy4CyTP4DZIpuNxSiGDHaBPiB2GwKdoixAJadSow2m4Kdf8N4x4X2Bfe3U2c6e2DvaJ9csTMhFi+i9xqJfU/kQ+ygzz+Pb1Kohi6oSMRTAAAAAElFTkSuQmCC",
            "name":"返回",
            "action":"fallback"
        }
    }
    function menuConfig() {
        window.webkit.messageHandlers.AppModel.postMessage({body: jsonStrBut});
        return jsonStrBut;
    }
    function jsonConfig() {
        var str = JSON.stringify(jsonStrBut);
        window.stub.jsMethod(str);
        return jsonStrBut;
    }
    function fallback() {
        if (projectId && projectId != '' && projectId != 'null') {
            window.location.href = B.serverUrl + "/mobile/services/donate/add.html?accountNum=" + accountNum +"&projectId="+ projectId;
        }else {
            window.location.href = B.serverUrl + "/mobile/services/donate/list_my.html?accountNum=" + accountNum;
        }



    }
</script>
</html>
