<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>电子期刊</title>
    <meta name="viewport" content="maximum-scale=1,minimum-scale=1,user-scalable=0,width=device-width,initial-scale=1"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <link href="../static/plug/swiper/swiper.min.css" rel="stylesheet" type="text/css"/>
    <link href="../static/css/Hui.css" rel="stylesheet" type="text/css"/>
    <link href="../static/css/dropload.css" rel="stylesheet" type="text/css"/>
    <link href="../static/font/iconfont.css" type="text/css" rel="stylesheet"/>
    <script src="../static/plug/swiper/swiper.min.js" type="text/javascript"></script>
    <script src="../../js/H.js" type="text/javascript"></script>
    <script src="../../js/zepto.min.js" type="text/javascript"></script>
    <script src="../../js/xdomain.min.js" type="text/javascript"></script>
    <script src="../../js/B.js" type="text/javascript"></script>
    <script src="../static/js/dropload.min.js" type="text/javascript"></script>
    <script src="../static/js/iscroll.js" type="text/javascript"></script>
    <script type="text/javascript" src="../../js/jbase64.js"></script>
    <script type="text/javascript" src="../../js/wechat.js"></script>
    <style type="text/css">


        body {
            background-color: #eaeaea;
            width: 100%;
            height: 100%;
        }

        .title_box {
            padding: 10px;
            padding: 25px 0;

        }

        .title_name {
            border: 1px solid #000;
            padding: 5px 10px;
            font-size: 15px;

        }

        .content {
            overflow: hidden;
        }

        .book_list {
            overflow: hidden;
        }

        .row_item {

            width: 31.9975vw;
            height: 39.665vw;
            padding: 0;
            margin-top: 8vw;
            position: relative;
            float: left;

        }

        /*匹配第1、第4、第7、…、每3个为一组的第1个LI*/
        .stage_box {
            height: 6.82vw;
            width: 100%;
            position: absolute;
            bottom: 0px;
            right: -1.9985vw;
            font-size: 12px;

        }

        .row_item:nth-child(3n+1) .stage_box {

            background-image: url(../static/img/stage_l.png);
            background-size: cover;

        }

        .row_item:nth-child(3n+1) .stage_box div {
            width: 20.15vw;
            text-align: center;

        }

        .row_item:nth-child(3n+2) .stage_box {
            background-image: url(../static/img/stage_m.png);
            background-size: cover;
            text-align: center;

        }

        .row_item:nth-child(3n+3) .stage_box {
            background-image: url(../static/img/stage_r.png);
            background-size: cover;

        }

        .row_item:nth-child(3n+3) .stage_box div {
            width: 20.15vw;
            text-align: center;
            margin-left: 12vw;
        }

        .book_box {
            position: relative;
            width: 28vw;
            padding-left: 3.997vw;
            padding-right: 0;
        }

        .gradient {
            position: absolute;
            width: 1.665vw;
            height: 37vw;
            background-image: -webkit-linear-gradient(left, rgba(0, 0, 0, 0.5) 0%, rgba(0, 0, 0, 0.3) 10%, rgba(0, 0, 0, 0) 100%);
        }

        .book_img {
            height: 37vw;
            width: 28vw;
            box-shadow: 7px 3px 15px rgba(0, 0, 0, 0.2);
            background-size: cover;

        }


    </style>

    <script type="text/html" id="tppl">
        <%for(var key in list){%>
        <div class="row_item">
            <a  href="<%=B.getImageAbsoluteUrl(list[key].uploadUrl)%>">
                <div class="book_box">
                    <div class="gradient"></div>
                    <img onerror="javascript:this.src='../static/img/tupian@2x.png';"
                         src="<%=B.getImageAbsoluteUrl(list[key].logoUrl)%>" class="book_img"
                         alt="" title="">
                </div>
            </a>
            <div class="stage_box">
                <div class="H-text-show-row-1"><%=list[key].name%></div>
            </div>
        </div>

        <%}%>
    </script>

</head>
<body>
<div class="H-theme-background-color-white " style="height:74px;border-bottom: 1px solid #ccc">
    <div class="title_box H-text-align-center">
        <img src="../static/img/flag.png" style="width:50px;vertical-align: middle;"/>
        <span class="title_name">2017书籍推荐</span>
    </div>

</div>

<div class="content">
    <div class="book_list">
        <!--<div class="row_item">
            <div class="book_box">
                <div class="gradient"></div>
                <img src="../static/img/tupian@2x.png" class="book_img" alt="" title="">
            </div>
            <div class="stage_box">
               <div>第10期</div>
            </div>
        </div>

        <div class="row_item">
            <div class="book_box">
                <div class="gradient"></div>
                <img src="../static/img/beijingtu@2x.png" class="book_img" alt="" title="">
            </div>
            <div class="stage_box">
                <div>第10期</div>
            </div>
        </div>

        <div class="row_item">
            <div class="book_box">
                <div class="gradient"></div>
                <img src="../static/img/nothing@3x.png" class="book_img" alt="" title="">
            </div>
            <div class="stage_box">
                <div>第10期</div>
            </div>
        </div>

        <div class="row_item">
            <div class="book_box">
                <div class="gradient"></div>
                <img src="../static/img/tupian@2x.png" class="book_img" alt="" title="">
            </div>
            <div class="stage_box">
                <div>第10期</div>
            </div>
        </div>

        <div class="row_item">
            <div class="book_box">
                <div class="gradient"></div>
                <img src="../static/img/beijingtu@2x.png" class="book_img" alt="" title="">
            </div>
            <div class="stage_box">
                <div>第10期</div>
            </div>
        </div>-->


    </div>
</div>


</body>

<script type="text/javascript">
    // 接收URL中的参数
    var accountNum = B.getUrlParamByName("accountNum");

    var openId = localStorage.getItem("openId");
    if (openId && openId != "null") {
        // 微信端
        accountNum = localStorage.getItem("accountNum");
        var shareData = {
            title: '电子期刊',
            desc: '',
            link: location.href.split('?')[0],
            imgUrl: ''
        };
        mkShareInfo(location.href, shareData, 0);
    }

    var type = '';

    // 页面初始化
    $(function () {
        // 定义模板标签符
        H.tppl_flag = ["<%", "%>"];

        //加载书籍列表
        loadBookList();


    });

    var total = 1;
    var flag = true;

    function loadBookList() {
        // 下拉刷新上拉加载
        //初始化节点
        $('.book_list').empty(); //移除donate_list节点中的内容
        $('.dropload-up').remove(); //移除整个dropload-up节点
        $('.dropload-down').remove();


        B.ready(function () {

            var page = 1;


            $('.content').dropload({
                scrollArea: window,
                /* domUp : {
                 domClass   : 'dropload-up',
                 domRefresh : '<div class="dropload-refresh">↓下拉刷新-书籍列表</div>',
                 domUpdate  : '<div class="dropload-update">↑释放更新-书籍列表</div>',
                 domLoad    : '<div class="dropload-load"><span class="loading"></span>加载中-亲，请耐心等待喔...</div>'
                 },*/
                /*  domDown : {
                 domClass   : 'dropload-down',
                 domRefresh : '<div class="dropload-refresh">↑上拉加载更多-书籍列表</div>',
                 domLoad    : '<div class="dropload-load"><span class="loading"></span>加载中-亲，请耐心等待喔...</div>',
                 domNoData  : '<div class="dropload-noData"></div>'
                 },*/

                loadDownFn: function (me) {
                    console.log('{"command": "614","content": {"page": "' + page + '","rows": "1"}}');
                    //判断是否
                    if (total && total >= 0) {
                        $.ajax({
                            type: 'post',
                            url: B.serverUrl + '/userProfile/userProfileAction!doNotNeedSessionAndSecurity_userProfileHandler.action',
                            data: {
                                jsonStr: '{"command": "614","content": {"page": "' + page + '","rows": "1"}}'
                            },
                            dataType: 'json',
                            success: function (data) {
                                console.log(data);
                                if (data.obj.rows.length == 0) {
                                    if (flag) {
                                        total = data.obj.total;
                                        flag = false;
                                    }
                                    page++;
                                    total =total - 1;
                                    if ( total <= 0) {
                                        me.lock();
                                        me.noData(true);
                                    }
                                } else {

                                    var render = H.tppl(H.D("#tppl").innerHTML);
                                    var result = render({list: data.obj.rows});
                                    if (flag) {
                                        total = data.obj.total;
                                        flag = false;
                                    }
                                    total =total - 1;
                                    $('.book_list').append(result);
                                    if ( total <= 0) {
                                        me.lock();
                                        me.noData(true);
                                    }
                                    page++;
                                }

                                // 每次数据加载完，必须重置
                                me.resetload();
                            },
                            error: function (xhr, type) {
                                // 即使加载出错，也得重置
                                // me.resetload();
                            }
                        });
                    } else {
                        me.lock();
                        me.noData(true);
                    }
                },
                threshold: 50
            });

        })
    }
    //校验url是否有效
    function isValid(url) {

        var flag = false;
        $.ajax({
            url: url,
            type: 'GET',
            async: false,
            success: function (response) {
//                alert(response.status);
                if (response.status == 404) {
                    flag = false;
//                    alert(flag);
                } else {
                    flag = true;
//                    alert(flag);
                }
            }
        });
//        alert(flag);
        return flag;
    }

    //    //ios返回刷新
    //    var t = B.getUrlParamByName("t");
    //    $(function () {
    //        var u = navigator.userAgent, app = navigator.appVersion;
    //        var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Linux') > -1; //g
    //        var isIOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
    //        if (isAndroid) {
    //
    //        }
    //        if (isIOS) {
    //            var rnumber = Math.floor(Math.random()*1000)
    //            history.replaceState({mod:rnumber}, 'Title', '?t='+t+'&accountNum='+accountNum+'&mod='+rnumber);
    //            window.onpopstate = function(event) {
    //                location.reload();
    //            };
    //        }
    //    });
    //返回
    var jsonStr = {
        "title": "电子期刊",
        "btn1": {
            "imgname": "icon_Back@2x.png",
            "imgversion": "20170214",
            "imgbase64": "iVBORw0KGgoAAAANSUhEUgAAABoAAAAsCAYAAAB7aah+AAAAAXNSR0IArs4c6QAAAN1JREFUWAntlkEOgkAMRRkTVl7EA3gPD+D53MjGa7lyr4vxF2gghkIHqnHxmzQdMp3+6YOkVFWw5ZxP8Cu8Di49lOtFnohiN3i8GIpKJyqCZWuxYig5JdJrdZ3thsbXrUQEJxt4PCa90kIn0tF2dBRR3K5IXC5MmkRcSsIVicuFSZOIS0l4owy+M3xuaF1SSi9vQTMP76aGy4CyTP4DZIpuNxSiGDHaBPiB2GwKdoixAJadSow2m4Kdf8N4x4X2Bfe3U2c6e2DvaJ9csTMhFi+i9xqJfU/kQ+ygzz+Pb1Kohi6oSMRTAAAAAElFTkSuQmCC",
            "name": "返回",
            "action": "fallback"
        }
    }
    function menuConfig() {
        window.webkit.messageHandlers.AppModel.postMessage({body: jsonStr});
        return jsonStr;
    }
    function jsonConfig() {
        var str = JSON.stringify(jsonStr);
        window.stub.jsMethod(str);
        return jsonStr;
    }
    function fallback() {

        window.location.href = B.serverUrl + "/mobile/services/eleBook/list.html?accountNum=" + accountNum;

    }
</script>
</html>